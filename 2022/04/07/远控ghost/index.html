<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>记第一个GitHub项目 --ghost远控 | ME_dition</title><meta name="author" content="ME_dition"><meta name="copyright" content="ME_dition"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="客户端界面的设计和编写1.1 创建窗口1.新建一个工程，看操作  我们必须给工程起一个响亮的名字 :-D  就叫CMDghost吧 2.添加最大化窗口，最小化窗口的属性  3.更改对话框到适当大小 4.添加服务端连接后显示的列表控件IDC_ONLINE，日志列表控件IDC_MESSAGE   6.添加列表控件变量m_CList_Online,m_CList_Message  7.相应对话框改变大小">
<meta property="og:type" content="article">
<meta property="og:title" content="记第一个GitHub项目 --ghost远控">
<meta property="og:url" content="http://example.com/2022/04/07/%E8%BF%9C%E6%8E%A7ghost/index.html">
<meta property="og:site_name" content="ME_dition">
<meta property="og:description" content="客户端界面的设计和编写1.1 创建窗口1.新建一个工程，看操作  我们必须给工程起一个响亮的名字 :-D  就叫CMDghost吧 2.添加最大化窗口，最小化窗口的属性  3.更改对话框到适当大小 4.添加服务端连接后显示的列表控件IDC_ONLINE，日志列表控件IDC_MESSAGE   6.添加列表控件变量m_CList_Online,m_CList_Message  7.相应对话框改变大小">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s2.loli.net/2022/04/09/5ifjTZXhEPV4bLp.jpg">
<meta property="article:published_time" content="2022-04-07T14:32:37.280Z">
<meta property="article:modified_time" content="2022-06-18T10:00:17.037Z">
<meta property="article:author" content="ME_dition">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/04/09/5ifjTZXhEPV4bLp.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2022/04/07/%E8%BF%9C%E6%8E%A7ghost/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="yandex-verification" content="{&quot;theme_color&quot;:{&quot;enable&quot;:true,&quot;main&quot;:&quot;#49B1F5&quot;,&quot;paginator&quot;:&quot;#00c4b6&quot;,&quot;button_hover&quot;:&quot;#FF7242&quot;,&quot;text_selection&quot;:&quot;#00c4b6&quot;,&quot;link_color&quot;:&quot;#99a9bf&quot;,&quot;meta_color&quot;:&quot;#858585&quot;,&quot;hr_color&quot;:&quot;#A4D8FA&quot;,&quot;code_foreground&quot;:&quot;#F47466&quot;,&quot;code_background&quot;:&quot;rgba(27, 31, 35, .05)&quot;,&quot;toc_color&quot;:&quot;#00c4b6&quot;,&quot;blockquote_padding_color&quot;:&quot;#49b1f5&quot;,&quot;blockquote_background_color&quot;:&quot;#49b1f5&quot;}}"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-06-18 18:00:17'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="ME_dition" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/null" onerror="onerror=null;src='/img/logo.jpg'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">26</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> music</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> movies</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://s2.loli.net/2022/04/09/5ifjTZXhEPV4bLp.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">ME_dition</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> music</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> Gallery</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> movies</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">记第一个GitHub项目 --ghost远控</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-04-07T14:32:37.280Z" title="Created 2022-04-07 22:32:37">2022-04-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-06-18T10:00:17.037Z" title="Updated 2022-06-18 18:00:17">2022-06-18</time></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="客户端界面的设计和编写"><a href="#客户端界面的设计和编写" class="headerlink" title="客户端界面的设计和编写"></a>客户端界面的设计和编写</h1><h2 id="1-1-创建窗口"><a href="#1-1-创建窗口" class="headerlink" title="1.1 创建窗口"></a>1.1 创建窗口</h2><p>1.新建一个工程，看操作  我们必须给工程起一个响亮的名字 :-D  就叫CMDghost吧</p>
<p>2.添加最大化窗口，最小化窗口的属性</p>
<p><img src="https://s2.loli.net/2022/04/07/DnJm8vQgNZKYwEu.png"></p>
<p>3.更改对话框到适当大小</p>
<p>4.添加服务端连接后显示的列表控件IDC_ONLINE，日志列表控件IDC_MESSAGE</p>
<p><img src="https://s2.loli.net/2022/04/07/BPiQouJmckgXetz.png"></p>
<p><img src="https://s2.loli.net/2022/04/07/otevpd6LEPWZCAq.png"></p>
<p>6.添加列表控件变量m_CList_Online,m_CList_Message</p>
<p><img src="https://s2.loli.net/2022/04/07/yJrF3RAUYCI6E2V.png"></p>
<p>7.相应对话框改变大小的消息WM_SIZE就是 向对话框抛出这个消息对话框就会改变大小，我们先相应这个消息，然后再把这个消息<br>  向下传递</p>
<p><img src="https://s2.loli.net/2022/04/07/mfPWCXMGOxEuaSd.png"></p>
<p>9.示范伸缩</p>
<p>10.伸缩同原来的有差别，介绍一个小技巧 在OnInitDialog:</p>
<p>当对话框改变时，WM_SIZE抛出消息由OnInitDialog响应，此时对话框还没有显示，可以在显示前改变对话框。</p>
<p><img src="https://s2.loli.net/2022/04/07/M8VW2OGDicPuR5s.png"></p>
<h2 id="1-2-添加列表中的列名"><a href="#1-2-添加列表中的列名" class="headerlink" title="1.2 添加列表中的列名"></a>1.2 添加列表中的列名</h2><p>1.参考gh0st的列表中的列名:<br>   0IP 1所在区域   2计算机名/备注  3操作系统  4CPU  5摄像头  6Ping</p>
<p>2.上一节我们为列表控件添加变量，我们来查看变量的类型:<br>  CListCtrl 类 查看MSDN  找到</p>
<pre><code>int InsertColumn(
                int nCol,                  //列的顺序
                LPCTSTR lpszColumnHeading, //列的名字
                int nFormat = LVCFMT_LEFT,  //列对齐的方式 LVCFMT_LEFT, LVCFMT_RIGHT,LVCFMT_CENTER
                int nWidth = -1,            //列的宽度
                int nSubItem = -1           //与之联系的子条目 默认为-1 我们不用写
                );</code></pre>
<p>3.有了这些我们可以现在就写入代码了，但请等一下我们来考虑一下以后的扩展问题，假如我们要加入新的列那会不会很麻烦，我们每一个列都写入了固定的</p>
<p>  顺序(0–6)没有考虑扩展，比如在CPU列的后面加入显示内存大小，那么加入的就是第5列，而第5列恰好是摄头，这样显示的数据就会混乱(其实这个正是我写</p>
<p>   PCRat时犯的错误)，解决这个问题的方式就是用枚举enum 写入列的顺序时不写入硬编码(0—-6)而是写入枚举成员这样我们只需很小的改动就能达到目的。</p>
<p>4.需要一个列表记录表格中的字符，因为这个列表比较重要所以要放到一个每一个文件都能访问到的文件，我这里选择了framework.h</p>
<pre><code>enum
&#123;
    ONLINELIST_IP=0,          //IP的列顺序
    ONLINELIST_ADDR,          //地址
    ONLINELIST_COMPUTER_NAME, //计算机名/备注
    ONLINELIST_OS,           //操作系统
    ONLINELIST_CPU,          //CPU
    ONLINELIST_VIDEO,       //摄像头
    ONLINELIST_PING          //PING
&#125;;</code></pre>
<p><img src="https://s2.loli.net/2022/04/07/oIXgDbcBy2khKYf.png"></p>
<p>5.处理列表的代码应该统一放在一处，添加列表处理的代码InitList()</p>
<p>虽然列表可以直接写在OnInitDialog，但直接在这里初始化太过臃肿，所以可以添加成员函数</p>
<p><img src="https://s2.loli.net/2022/04/07/QImhWR61zrlBkMC.png"></p>
<p><img src="https://s2.loli.net/2022/04/07/UuWYy42olTQXPiM.png"></p>
<p>6.写入加入列表列名的代码:</p>
<p>   列表的名字与列表的宽度是同一一对应的关系，以后为了以后修改方便建立这样的一个结构体:</p>
<pre><code> typedef struct
&#123;
    char    *title;           //列表的名称
    int        nWidth;   //列表的宽度
&#125;COLUMNSTRUCT;</code></pre>
<p>以char类型表示 列表的名字，以int 类型表示列表的宽度</p>
<p>然后建立这个结构体变量的数组</p>
<pre><code>   COLUMNSTRUCT g_Column_Data[] = 
&#123;
    &#123;&quot;IP&quot;,                148    &#125;,
    &#123;&quot;区域&quot;,            150    &#125;,
    &#123;&quot;计算机名/备注&quot;,    160    &#125;,
    &#123;&quot;操作系统&quot;,        128    &#125;,
    &#123;&quot;CPU&quot;,                80    &#125;,
    &#123;&quot;摄像头&quot;,            81    &#125;,
    &#123;&quot;PING&quot;,            81    &#125;
&#125;;</code></pre>
<p>添加全局变量int g_Column_Count=7; //列表的个数</p>
<p><img src="https://s2.loli.net/2022/04/07/fNjlEcgLYiHpx56.png"></p>
<p>7.在initList中写入加入列表列名称的代码并解释:</p>
<pre><code> for (int i = 0; i &lt; g_Column_Count; i++)
&#123;
    m_CList_Online.InsertColumn(i, g_Column_Data[i].title,g_Column_Data[i].nWidth);
&#125;</code></pre>
<p><img src="https://s2.loli.net/2022/04/08/3h2bHCqJBLTdQY9.png"></p>
<p>我这里会报错，是因为使用了uncode字符集，需要修改为使用多字节字符集</p>
<p><img src="https://s2.loli.net/2022/04/08/WkTnhIuSazoYs6Z.png"></p>
<p><img src="https://s2.loli.net/2022/04/08/YZQOUBiDc8HqvWf.png"></p>
<pre><code>int InsertColumn(
                int nCol,                  //列的顺序
                LPCTSTR lpszColumnHeading, //列的名字
                int nFormat = LVCFMT_LEFT,  //列对齐的方式 LVCFMT_LEFT, LVCFMT_RIGHT,LVCFMT_CENTER
                int nWidth = -1,            //列的宽度
                int nSubItem = -1           //与之联系的子条目 默认为-1 我们不用写
                );</code></pre>
<p>再看一下InsertColumn ，传入的参数分别是顺序，名字，对齐方式 ，宽度</p>
<p>8.在OnInitDialog中写入InitList()</p>
<p><img src="https://s2.loli.net/2022/04/08/GsYkU6KASh8MiOQ.png"></p>
<p>9.改变列表控件的属性 ICon  改为Report</p>
<p><img src="https://s2.loli.net/2022/04/08/31zbUCPuqNsEglw.png"></p>
<p>10.同样的方法改动日志消息的列表控件看操作</p>
<pre><code>  //变量声明
   int g_Column_Count_Online=7; //列表的个数

COLUMNSTRUCT g_Column_Data_Message[] = 
&#123;
    &#123;&quot;信息类型&quot;,        68    &#125;,
    &#123;&quot;时间&quot;,            100    &#125;,
    &#123;&quot;信息内容&quot;,        660    &#125;
&#125;;


//InitList

for (int i = 0; i &lt; g_Column_Message; i++)
    &#123;
        m_CList_Message.InsertColumn(i, g_Column_Data_Message[i].title,LVCFMT_CENTER,g_Column_Data_Message[i].nWidth);
    &#125;</code></pre>
<p>11.改变列表控件的属性 ICon  改为Report</p>
<h2 id="1-3-列表的列宽度支持伸缩"><a href="#1-3-列表的列宽度支持伸缩" class="headerlink" title="1.3 列表的列宽度支持伸缩"></a>1.3 列表的列宽度支持伸缩</h2><p>1.CListCtrl  SetColumnWidth   查看MSDN<br>             BOOL SetColumnWidth(<br>                             int nCol,             //列索引<br>                             int cx                //列宽度<br>             );</p>
<p>2.声明列的总宽度:</p>
<pre><code>        int g_Column_Online_Width=0;  //列总宽度</code></pre>
<p><img src="https://s2.loli.net/2022/04/08/HCIDbnodrX81jMx.png"></p>
<p>3.得到列的总宽度 initlist中:</p>
<pre><code>       g_Column_Online_Width+=g_Column_Online_Data[i].nWidth;       //得到总宽度</code></pre>
<p><img src="https://s2.loli.net/2022/04/08/H8MpOYorKimk2jt.png"></p>
<p>4.在OnSize 添加代码:</p>
<pre><code>      double dcx=cx;     //对话框的总宽度

      for(int i=0;i&lt;g_Column_Online_Count;i++)&#123;                   //遍历每一个列
        double dd=g_Column_Online_Data[i].nWidth;     //得到当前列的宽度
        dd/=g_Column_Online_Width;                    //看一看当前宽度占总长度的几分之几
        dd*=dcx;                                       //用原来的长度乘以所占的几分之几得到当前的宽度
        int lenth=dd;                                   //转换为int 类型
        m_CList_Online.SetColumnWidth(i,(lenth));        //设置当前的宽度
    &#125;</code></pre>
<p><img src="https://s2.loli.net/2022/04/08/EP1k6xIysCfbm8K.png"></p>
<p>5.解释为什么用double</p>
<pre><code>          double   0.1        int 0 
            90.23232</code></pre>
<p>6.改变日志的列表宽度(与之前相同)</p>
<pre><code>  (1)int g_Column_Message_Width = 0;  //列总宽度
   (2)g_Column_Message_Width += g_Column_Data_Message[i].nWidth;       //得到总宽度


   for (int i = 0;i &lt; g_Column_Message;i++) &#123;                   //遍历每一个列
            double dd = g_Column_Data_Message[i].nWidth;     //得到当前列的宽度
            dd /= g_Column_Message_Width;                    //看一看当前宽度占总长度的几分之几
            dd *= dcx;                                       //用原来的长度乘以所占的几分之几得到当前的宽度
            int lenth = dd;                                   //转换为int 类型
            m_CList_Message.SetColumnWidth(i, (lenth));        //设置当前的宽度
        &#125;</code></pre>
<h2 id="1-4-列表中添加条目"><a href="#1-4-列表中添加条目" class="headerlink" title="1.4 列表中添加条目"></a>1.4 列表中添加条目</h2><p>1.CListCtrl    </p>
<pre><code>           InsertItem  插入条目
           int InsertItem(
                     int nItem,              //插入哪一行
                     LPCTSTR lpszItem        //该行0列显示的字符
           );

          SetItemText         设置哪个列的字符
          BOOL SetItemText(
                      int nItem,                   //改动那个行
                      int nSubItem,                //该行中那个子列
                      LPCTSTR lpszText             //要设置的字符
          );</code></pre>
<p>2.列表设计思路:</p>
<pre><code>         (1)服务端上线后要显示在列表中，这样有一个统一的函数来处理会使代码更加简洁。

         (2)消息显示分为成功失败两种，还要在其中显示消息产生的时间，这样也应该有一个统一的函数来处理。</code></pre>
<p>3.上线列表添加处理:</p>
<pre><code>void CPCRemoteDlg::AddList(CString strIP, CString strAddr, CString strPCName, CString strOS, CString strCPU, CString strVideo, CString strPing)
&#123;
    m_CList_Online.InsertItem(0,strIP);           //默认为0行  这样所有插入的新列都在最上面
    m_CList_Online.SetItemText(0,ONLINELIST_ADDR,strAddr);      //设置列的显示字符   这里 ONLINELIST_ADDR等 为第二节课中的枚举类型 用这样的方法
    m_CList_Online.SetItemText(0,ONLINELIST_COMPUTER_NAME,strPCName); //解决问题会避免以后扩展时的冲突
    m_CList_Online.SetItemText(0,ONLINELIST_OS,strOS); 
    m_CList_Online.SetItemText(0,ONLINELIST_CPU,strCPU);
    m_CList_Online.SetItemText(0,ONLINELIST_VIDEO,strVideo);
    m_CList_Online.SetItemText(0,ONLINELIST_PING,strPing); 
&#125;</code></pre>
<p>在类视图CMFghostDlg中添加函数AddList ，并设置参数</p>
<p><img src="https://s2.loli.net/2022/04/09/iEhekLbNM5ZuAYg.png"></p>
<p>在资源管理器CMFCghostDlg中的AddList设置函数体</p>
<p><img src="https://s2.loli.net/2022/04/09/iQPMCouB1mKV53l.png"></p>
<p>4.添加日志消息的处理:</p>
<pre><code>// show msg 
void CPCRemoteDlg::ShowMessage(bool bIsOK, CString strMsg)
&#123;
    CString strIsOK,strTime;
    CTime t=CTime::GetCurrentTime();
    strTime=t.Format(&quot;%H:%M:%S&quot;);
    if (bIsOK)
    &#123;
        strIsOK=&quot;执行成功&quot;;
    &#125;else&#123;
        strIsOK=&quot;执行失败&quot;;
    &#125;
     m_CList_Message.InsertItem(0,strIsOK);
     m_CList_Message.SetItemText(0,1,strTime);
     m_CList_Message.SetItemText(0,2,strMsg);
&#125;</code></pre>
<p>在类视图CMFghostDlg中添加函数ShowMessage ，并设置参数</p>
<p><img src="https://s2.loli.net/2022/04/09/UL7KifCmHzEW681.png"></p>
<p>在资源管理器CMFCghostDlg中的ShowMessage设置函数体</p>
<p><img src="https://s2.loli.net/2022/04/09/dXDowiTUIMcug2L.png"></p>
<p>5.添加伪上线，和日志的测试代码,在没有加入gh0st传输内核之前是要自己测试的，所以要加入一个用于测试的函数:</p>
<pre><code>void CPCRemoteDlg::Test(void)
&#123;
    AddList(&quot;192.168.0.1&quot;,&quot;本机局域网&quot;,&quot;Lang&quot;,&quot;Windows7&quot;,&quot;2.2GHZ&quot;,&quot;有&quot;,&quot;123232&quot;);
    ShowMessage(true,&quot;软件初始化成功...&quot;);
&#125;</code></pre>
<p><img src="https://s2.loli.net/2022/04/09/sLc6w5Xjr8PIM9N.png"></p>
<p>  然后在OnInitDialog  中添加:</p>
<pre><code>Test();</code></pre>
<p><img src="https://s2.loli.net/2022/04/09/AwPYzoeFSOEL4im.png"></p>
<p>6.点击时整个列都是选中状态</p>
<pre><code> InitList():中加入代码:
   m_CList_Online.SetExtendedStyle(LVS_EX_FULLROWSELECT);

   m_CList_Message.SetExtendedStyle(LVS_EX_FULLROWSELECT);</code></pre>
<p><img src="https://s2.loli.net/2022/04/09/TSfY6GxaLEzcKq9.png"></p>
<h2 id="1-5-列表中显示弹出菜单"><a href="#1-5-列表中显示弹出菜单" class="headerlink" title="1.5 列表中显示弹出菜单"></a>1.5 列表中显示弹出菜单</h2><p>在资源视图中选择添加资源 menu </p>
<p><img src="https://s2.loli.net/2022/04/09/bBfFzMtqKHZgx2w.png"></p>
<p>在该menu视图中编辑内容</p>
<p><img src="https://s2.loli.net/2022/04/09/7VF6xWbmiozn4a3.png"></p>
<p>添加响应函数</p>
<p>在类视图中点击MFCghostDlg,选择属性，在IDC_ONLINE中设置NM_RCLICK事件.这样点击后就可触发响应函数中的代码。</p>
<p><img src="https://s2.loli.net/2022/04/09/qkui1hzbd9arpwN.png"></p>
<p><img src="https://s2.loli.net/2022/04/09/AgI3TkaDYw4UEMo.png"></p>
<p>填充函数</p>
<p><img src="https://s2.loli.net/2022/04/09/2OlUzuJhg5KIM6Y.png"></p>
<p><img src="https://s2.loli.net/2022/04/09/pBXv194uzrcRNkH.png"></p>
<pre><code>CMenu    popup;     //申明菜单变量
popup.LoadMenu(IDR_MENU_ONLINE);  //加载菜单项
CMenu* pM = popup.GetSubMenu(0);  //得到菜单项
CPoint    p;                       
GetCursorPos(&amp;p);             //得到鼠标位置
int    count = pM-&gt;GetMenuItemCount();     //得到菜单项的个数
if (m_CList_Online.GetSelectedCount() == 0)       //如果没有选中
&#123;
    for (int i = 0; i &lt; count; i++)
    &#123;
        pM-&gt;EnableMenuItem(i, MF_BYPOSITION | MF_DISABLED | MF_GRAYED);          //菜单全部变灰
    &#125;

&#125;
pM-&gt;TrackPopupMenu(TPM_LEFTALIGN, p.x, p.y, this);    //显示菜单项
*pResult = 0;</code></pre>
<p>这样点击右键就可以看到列表了</p>
<p><img src="https://s2.loli.net/2022/04/09/pXR4Fub5iZPMglh.jpg"></p>
<h2 id="1-6-添加菜单消息响应，从列表中删除条目"><a href="#1-6-添加菜单消息响应，从列表中删除条目" class="headerlink" title="1.6 添加菜单消息响应，从列表中删除条目"></a>1.6 添加菜单消息响应，从列表中删除条目</h2><p>1.添加菜单消息响应的函数:</p>
<pre><code>     终端管理     进程管理    窗口管理    桌面管理     文件管理    语音管理     视频管理   服务管理     注册表管理</code></pre>
<p><img src="https://s2.loli.net/2022/04/12/2aQ9DxgmqnYR5Wp.png"></p>
<p>2.删除列表中的条目:</p>
<pre><code>  CListCtrl       (1)DeleteItem
                BOOL DeleteItem(
                             int nItem              //列表的索引  从0开始
               );
                 (2)GetSelectionMark
                   int GetSelectionMark( );        //得到用户选中的条目索引</code></pre>
<p>3.添加下线菜单  断开连接   ID:   IDM_ONLINE_DELETE</p>
<p><img src="https://s2.loli.net/2022/04/12/prwSgQVt5zUBoyq.png"></p>
<p>4.添加菜单响应消息，添加代码:</p>
<pre><code>                 int iSelect=m_CList_Online.GetSelectionMark( );
                         m_CList_Online.DeleteItem(iSelect);</code></pre>
<p><img src="https://s2.loli.net/2022/04/12/E6nAFVB5mCzYoc9.png"></p>
<p>5.产生下线日志: </p>
<pre><code>         CListCtrl     GetItemText 
                       CString GetItemText(
                                         int nItem,          //哪一行
                                         int nSubItem        //行中的那个子列
                       ) const;</code></pre>
<p>6.接着添加代码:</p>
<pre><code>CString strIP;
int iSelect=m_CList_Online.GetSelectionMark( );
strIP=m_CList_Online.GetItemText(iSelect,ONLINELIST_IP);
m_CList_Online.DeleteItem(iSelect);
strIP+=&quot;断开连接&quot;;
ShowMessage(true,strIP);</code></pre>
<p><img src="https://s2.loli.net/2022/04/12/E6nAFVB5mCzYoc9.png"></p>
<h2 id="1-7-为对话框添加菜单栏并添加事件响应"><a href="#1-7-为对话框添加菜单栏并添加事件响应" class="headerlink" title="1.7 为对话框添加菜单栏并添加事件响应"></a>1.7 为对话框添加菜单栏并添加事件响应</h2><p>1.创建菜单的资源  ID:  IDR_MENU_MAIN</p>
<p>2.添加菜单: </p>
<pre><code>        文件--退出(IDM_MAIN_CLOSE)
        设置--参数设置(IDM_MAIN_SET)----生成服务端(IDM_MAIN_BUILD)
        帮助--关于(IDM_MAIN_ABOUT)</code></pre>
<p><img src="https://s2.loli.net/2022/04/12/B3Obu9kWsejZVXJ.png"></p>
<p>3.为对话框添加代码,显示菜单:</p>
<pre><code>   (1) 认识几个API函数:
          HMENU LoadMenu(                    //载入菜单 
              HINSTANCE hInstance,          //资源所在文件模块的句柄标识
               LPCTSTR lpMenuName           //资源ID
           );
            BOOL SetMenu(                  //为窗口设置菜单
              HWND hWnd,                 //要设置菜单的窗口句柄
              HMENU hMenu                //菜单标识
            );
           BOOL DrawMenuBar(          //显示菜单
                   HWND hWnd          //要显示菜单的窗口句柄
            );

  (2)添加添加菜单的代码  oninitdialog


HMENU hmenu;
hmenu=LoadMenu(NULL,MAKEINTRESOURCE(IDR_MENU_MAIN));  //载入菜单资源
::SetMenu(this-&gt;GetSafeHwnd(),hmenu);                  //为窗口设置菜单
::DrawMenuBar(this-&gt;GetSafeHwnd());                    //显示菜单</code></pre>
<p><img src="https://s2.loli.net/2022/04/12/bdOMu6CvSpmxarH.png"></p>
<p>3.为每一个菜单添加事件响应</p>
<p>4.添加代码:</p>
<pre><code>  退出菜单代码:
         BOOL PostMessage(          HWND hWnd,             //标识向那个窗口发送消息
                                    UINT Msg,              //消息内容
                                    WPARAM wParam,         //消息参数
                                     LPARAM lParam          //消息参数
        );

         PostMessage(WM_CLOSE,0,0);

 关于菜单代码:
       CAboutDlg dlgAbout;
       dlgAbout.DoModal();
其他代码用MessageBox代替</code></pre>
<p><img src="https://s2.loli.net/2022/04/12/mk4VcpKFatSOPAT.png"></p>
<h2 id="1-8-为对话框添加状态条并在态条上显示文字"><a href="#1-8-为对话框添加状态条并在态条上显示文字" class="headerlink" title="1.8 为对话框添加状态条并在态条上显示文字"></a>1.8 为对话框添加状态条并在态条上显示文字</h2><p>1.创建字符串资源  ID:  IDR_STATUSBAR_STRING</p>
<p><img src="https://s2.loli.net/2022/04/12/n3JocdkfFtDLY28.png"></p>
<p>2.添加状态条变量:</p>
<pre><code>    CStatusBar  m_wndStatusBar;              //状态条</code></pre>
<p><img src="https://s2.loli.net/2022/04/12/5lsGuxqZbKW8HXz.png"></p>
<p>3.查看MSDN:</p>
<pre><code>    CStatusBar  SetIndicators      
                BOOL SetIndicators(           //在状态条中加入对应字符串ID
                      const UINT* lpIDArray,   //字符串ID         
                               int nIDCount     //个数
                );

                void SetPaneInfo(         //设置状态条的显示状态
                              int nIndex,     //状态条的索引
                              UINT&amp; nID,      //状态条的字符ID
                              UINT&amp; nStyle,    //状态条的样式
                               int&amp; cxWidth    //状态条的宽度
                ) const;</code></pre>
<p>4.写入代码创建状态条的代码:</p>
<pre><code>  (1)  创建字符ID的数组
           static UINT indicators[] =
           &#123;
           IDR_STATUSBAR_STRING
               &#125;;
   (2)添加CreatStatusBar函数并写入代码:
        if (!m_wndStatusBar.Create(this) ||
    !m_wndStatusBar.SetIndicators(indicators,
    sizeof(indicators)/sizeof(UINT)))                    //创建状态条并设置字符资源的ID
     &#123;
    TRACE0(&quot;Failed to create status bar\n&quot;);
    return ;      // fail to create
         &#125;
       CRect rc;
       ::GetWindowRect(m_wndStatusBar.m_hWnd,rc);             
       m_wndStatusBar.MoveWindow(rc);                              //移动状态条到指定位置

   (3)在OnSize 中添加代码:
          if(m_wndStatusBar.m_hWnd!=NULL)&#123;    //当对话框大小改变时 状态条大小也随之改变
    CRect rc;
    rc.top=cy-20;
    rc.left=0;
    rc.right=cx;
    rc.bottom=cy;
    m_wndStatusBar.MoveWindow(rc);
    m_wndStatusBar.SetPaneInfo(0, m_wndStatusBar.GetItemID(0),SBPS_POPOUT, cx-10);
     &#125;</code></pre>
<p><img src="https://s2.loli.net/2022/04/12/8CZcbr5MelhJNmo.png"></p>
<p><img src="https://s2.loli.net/2022/04/12/wirknzpZFV2yejQ.png"></p>
<p>5.写入状态上显示文字的代码:</p>
<pre><code>       .h中添加变量 int iCount

   CString strStatusMsg;
if (strMsg.Find(&quot;上线&quot;)&gt;0)         //处理上线还是下线消息
&#123;
    iCount++;
&#125;else if (strMsg.Find(&quot;下线&quot;)&gt;0)
&#123;
    iCount--;
&#125;else if (strMsg.Find(&quot;断开&quot;)&gt;0)
&#123;
    iCount--;
&#125;
iCount=(iCount&lt;=0?0:iCount);         //防止iCount 有-1的情况
strStatusMsg.Format(&quot;有%d个主机在线&quot;,iCount);
m_wndStatusBar.SetPaneText(0,strStatusMsg);   //在状态条上显示文字</code></pre>
<p>6.列表中添加条目时产生日志:<br>      Addlist 中添加<br>            ShowMessage(true,strIP+”主机上线”);</p>
<p><img src="https://s2.loli.net/2022/04/12/JHmvZsquXLFzoOM.png"></p>
<p><img src="https://s2.loli.net/2022/04/12/JQnEcyTPVWdLghX.png"></p>
<h2 id="1-9-为对话框添加入工具条"><a href="#1-9-为对话框添加入工具条" class="headerlink" title="1.9 为对话框添加入工具条"></a>1.9 为对话框添加入工具条</h2><p>1.创建工具条资源  ID:  IDR_TOOLBAR_MAIN<br>添加 IDR_TOOLBAR_MAIN 时 修改大小</p>
<pre><code>              共12个工具条  9+3</code></pre>
<p><img src="https://s2.loli.net/2022/04/12/JqybaXdp5SKZc7j.png"></p>
<p>2.添加BMP资源:</p>
<p>图片格式需要为bmp图片，在bitmap中导入资源</p>
<pre><code>             ID:  IDB_BITMAP_MAIN</code></pre>
<p><img src="https://s2.loli.net/2022/04/12/jvJunAY8Nyb6xOm.png"></p>
<p>3.复制TrueColorToolBar文件，添加CTrueColorToolBar类.</p>
<p><img src="https://s2.loli.net/2022/04/12/9mDTJvgaurNlhKW.png"></p>
<p>4.添加:</p>
<pre><code>   #include &quot;TrueColorToolBar.h&quot;</code></pre>
<p><img src="https://s2.loli.net/2022/04/12/dKJROn94WU3vCPt.png"></p>
<p>5.声明变量:<br>      CTrueColorToolBar m_ToolBar; </p>
<p><img src="https://s2.loli.net/2022/04/12/lN98XT5uydH6RSV.png"></p>
<p>6.添加CreateToolBar()函数</p>
<p>7.分析CTrueColorToolBar类:</p>
<pre><code>                    继承CToolBar</code></pre>
<p>8.查看MSDN  CToolBar类:</p>
<p>9.CreateToolBar()函数中写入代码:<br>        if (!m_ToolBar.CreateEx(this, TBSTYLE_FLAT, WS_CHILD | WS_VISIBLE | CBRS_TOP<br>        | CBRS_GRIPPER | CBRS_TOOLTIPS | CBRS_FLYBY | CBRS_SIZE_DYNAMIC) ||<br>        !m_ToolBar.LoadToolBar(IDR_TOOLBAR_MAIN))<br>    {<br>        TRACE0(“Failed to create toolbar\n”);<br>        return;      // fail to create<br>    }<br>    m_ToolBar.ModifyStyle(0, TBSTYLE_FLAT);    //Fix for WinXP<br>    m_ToolBar.LoadTrueColorToolBar<br>        (<br>        48,    //加载真彩工具条<br>        IDB_BITMAP_MAIN,<br>        IDB_BITMAP_MAIN,<br>        IDB_BITMAP_MAIN<br>        );<br>    RECT rt,rtMain;<br>    GetWindowRect(&amp;rtMain);<br>    rt.left=0;<br>    rt.top=0;<br>    rt.bottom=80;<br>    rt.right=rtMain.right-rtMain.left+10;<br>    m_ToolBar.MoveWindow(&amp;rt,TRUE);</p>
<pre><code>m_ToolBar.SetButtonText(0,&quot;终端管理&quot;);  
m_ToolBar.SetButtonText(1,&quot;进程管理&quot;); 
m_ToolBar.SetButtonText(2,&quot;窗口管理&quot;); 
m_ToolBar.SetButtonText(3,&quot;桌面管理&quot;); 
m_ToolBar.SetButtonText(4,&quot;文件管理&quot;); 
m_ToolBar.SetButtonText(5,&quot;语音管理&quot;); 
m_ToolBar.SetButtonText(6,&quot;视频管理&quot;); 
m_ToolBar.SetButtonText(7,&quot;服务管理&quot;); 
m_ToolBar.SetButtonText(8,&quot;注册表管理&quot;); 
m_ToolBar.SetButtonText(10,&quot;参数设置&quot;); 
m_ToolBar.SetButtonText(11,&quot;生成服务端&quot;); 
m_ToolBar.SetButtonText(12,&quot;帮助&quot;); 
RepositionBars(AFX_IDW_CONTROLBAR_FIRST,AFX_IDW_CONTROLBAR_LAST,0);</code></pre>
<p>10.OnSize中添加代码:<br>        if(m_ToolBar.m_hWnd!=NULL)              //工具条<br>    {<br>        CRect rc;<br>        rc.top=rc.left=0;<br>        rc.right=cx;<br>        rc.bottom=80;<br>        m_ToolBar.MoveWindow(rc);     //设置工具条大小位置<br>    }</p>
<p><img src="https://s2.loli.net/2022/04/12/L4nlZVbR2x1gXeA.png"></p>
<p>11.Oninitdialog 中添加CreateToolBar</p>
<p><img src="https://s2.loli.net/2022/04/12/zdhNXMwyoP6ns2k.png"></p>
<h2 id="1-10-为程序添加系统托盘"><a href="#1-10-为程序添加系统托盘" class="headerlink" title="1.10 为程序添加系统托盘"></a>1.10 为程序添加系统托盘</h2><p>1.创建菜单资源<br>                ID:  IDR_MENU_NOTIFY<br>                添加子菜单  显示  IDM_NOTIFY_SHOW<br>                            退出  IDM_NOTIFY_CLOSE</p>
<p><img src="https://s2.loli.net/2022/04/12/wLs1qh7MbUpIN3v.png"></p>
<p>2.认识一个API</p>
<pre><code>    Shell_NotifyIcon
     BOOL Shell_NotifyIcon(                    //向系统托盘中加入图标
                       DWORD dwMessage,         //状态           
                       PNOTIFYICONDATA lpdata   //含有图标  消息响应 的一个结构体
     );</code></pre>
<p> 3.认识NOTIFYICONDATA  结构体:</p>
<pre><code>       typedef struct _NOTIFYICONDATA &#123;
DWORD cbSize;       //结构体自身大小
HWND hWnd;          //托盘的父窗口  托盘发出的消息由哪一个窗口响应
UINT uID;           //显示图标的ID
UINT uFlags;         //托盘的状态 (如有图标，有气泡提示，有消息响应等)
UINT uCallbackMessage; //托盘事件的消息响应函数
HICON hIcon;            //图标的变量
TCHAR szTip[64];        //气泡的显示文字
DWORD dwState;          //图标的显示状态
DWORD dwStateMask;      //图标的显示状态
TCHAR szInfo[256];      //气泡的显示文字  (可以忽略)
union &#123;
    UINT uTimeout;
    UINT uVersion;
&#125;;
TCHAR szInfoTitle[64];
DWORD dwInfoFlags;
GUID guidItem;
HICON hBalloonIcon;
    &#125; NOTIFYICONDATA, *PNOTIFYICONDATA;</code></pre>
<p>4.在oninitdialog函数中写入加入系统脱盘的代码:</p>
<pre><code>      nid.cbSize = sizeof(nid);     //大小赋值
nid.hWnd = m_hWnd;           //父窗口
nid.uID = IDR_MAINFRAME;     //icon  ID
nid.uFlags = NIF_MESSAGE | NIF_ICON | NIF_TIP;   //托盘所拥有的状态
nid.uCallbackMessage = UM_ICONNOTIFY;            //回调消息
nid.hIcon = m_hIcon;                            //icon 变量
CString str=&quot;PCRemote远程协助软件.........&quot;;       //气泡提示
lstrcpyn(nid.szTip, (LPCSTR)str, sizeof(nid.szTip) / sizeof(nid.szTip[0]));
Shell_NotifyIcon(NIM_ADD, &amp;nid);   //显示托盘</code></pre>
<p><img src="https://s2.loli.net/2022/04/12/JgPx1KCwdGEmo3U.png"></p>
<p>5.演示 ，在窗口销毁时托盘依然存在</p>
<p>6.添加WM_CLOSE消息并写入代码:</p>
<pre><code>  Shell_NotifyIcon(NIM_DELETE, &amp;nid); //销毁图标</code></pre>
<p><img src="https://s2.loli.net/2022/04/12/isYezB3c72dGWwE.png"></p>
<p>7.stdafx.h文件中加入自定义消息的定义</p>
<pre><code> //自定义消息
enum
&#123;
    UM_ICONNOTIFY= WM_USER+0x100,
&#125;;</code></pre>
<p><img src="https://s2.loli.net/2022/04/12/CBhz1opLE2iDUF7.png"></p>
<p>8.声明消息处理函数:<br>     afx_msg void OnIconNotify(WPARAM wParam,LPARAM lParam);</p>
<p><img src="https://s2.loli.net/2022/04/12/L3KmbZXthj5IrRU.png"></p>
<ol start="9">
<li> cpp文件中写入代码:</li>
</ol>
<pre><code>       void CPCRemoteDlg::OnIconNotify(WPARAM wParam, LPARAM lParam)
&#123;
    switch ((UINT)lParam)
    &#123;
    case WM_LBUTTONDOWN: // click or dbclick left button on icon
    case WM_LBUTTONDBLCLK: // should show desktop
        if (!IsWindowVisible()) 
            ShowWindow(SW_SHOW);
        else
            ShowWindow(SW_HIDE);
        break;
    case WM_RBUTTONDOWN: // click right button, show menu
        CMenu menu;
        menu.LoadMenu(IDR_MENU_NOTIFY);
        CPoint point;
        GetCursorPos(&amp;point);
        SetForegroundWindow();
        menu.GetSubMenu(0)-&gt;TrackPopupMenu(
            TPM_LEFTBUTTON|TPM_RIGHTBUTTON, 
            point.x, point.y, this, NULL); 
        PostMessage(WM_USER, 0, 0);
        break;
    &#125;
&#125;</code></pre>
<p><img src="https://s2.loli.net/2022/04/12/IO4iAPXxTUgLYCB.png"></p>
<p>10.添加消息响应:</p>
<pre><code>ON_MESSAGE(UM_ICONNOTIFY, (LRESULT (__thiscall CWnd::* )(WPARAM,LPARAM))OnIconNotify)  </code></pre>
<p><img src="https://s2.loli.net/2022/04/12/v3z8L612QKfTpku.png"></p>
<p>11.添加显示菜单消息响应</p>
<h1 id="二、加入Socket数据传输的内核"><a href="#二、加入Socket数据传输的内核" class="headerlink" title="二、加入Socket数据传输的内核"></a>二、加入Socket数据传输的内核</h1><h2 id="2-3"><a href="#2-3" class="headerlink" title="2.3"></a>2.3</h2><p>1.复制gh0st主控端的include文件夹到我们的工程下。</p>
<p><img src="https://s2.loli.net/2022/04/20/9ICSdqjN5RmcZgL.png"></p>
<p><img src="https://s2.loli.net/2022/04/20/lzQVfowE984BJbW.png"></p>
<p>2.包含复制过来的include 文件夹下的文件。</p>
<p>选择 项目 -&gt; 添加现有项 -&gt; 选择include所有文件</p>
<p><img src="https://s2.loli.net/2022/04/20/g2OZuF6BScCVKoN.png"></p>
<p>3.复制common文件夹到我们的工程的上一层目录下。</p>
<p>4.改变 #include “zlib\zlib.h”  的文件路径#include “......\common\zlib\zlib.h”</p>
<p><img src="https://s2.loli.net/2022/04/20/iIt9UuYgp2Ax1aB.png"></p>
<p>根据本地文件位置修改</p>
<p>5.注释掉//#include “../MainFrm.h”<br>6.添加....\common\zlib\zlib.lib库</p>
<pre><code>属性--&gt;连接器--&gt;输入--&gt;附加依赖项 ..\..\common\zlib\zlib.lib</code></pre>
<p><img src="https://s2.loli.net/2022/04/20/gQID4tXa9S6Mshf.png"></p>
<p>7.忽略特定默认库LIBCMT.lib</p>
<p><img src="https://s2.loli.net/2022/04/20/hYVynA38Iz7mCPX.png"></p>
<p>遇到报错：</p>
<p>在查找预编译头时遇到意外的文件结尾。是否忘记了向源中添加“#include “pch.h””?</p>
<p>解决办法：取消预编译头：</p>
<p>菜单栏，项目 ——&gt; 【项目名称】属性 ——&gt; 配置属性 ——&gt; c/c++  ——&gt; 预编译头</p>
<p><img src="https://s2.loli.net/2022/04/20/dFqcHT6D2S1wAfg.png"></p>
<p>8.编译成功ok…………</p>
<h2 id="2-4加入端口监听功能"><a href="#2-4加入端口监听功能" class="headerlink" title="2.4加入端口监听功能"></a>2.4加入端口监听功能</h2><p>1.分析gh0st监听端口的代码:</p>
<pre><code>         Activate(UINT nPort, UINT nMaxConnections)</code></pre>
<p>2.需要一个回调函数</p>
<pre><code>       NotifyProc</code></pre>
<p>3.复制NotifyProc 代码  去掉多余的代码</p>
<p><img src="https://s2.loli.net/2022/04/20/5Bh8yITvCAW7qDN.png"></p>
<pre><code>void CALLBACK CMFCghostDlg::NotifyProc(LPVOID lpParam, ClientContext* pContext, UINT nCode)
&#123;
    try
    &#123;

        switch (nCode)
        &#123;
        case NC_CLIENT_CONNECT:
            break;
        case NC_CLIENT_DISCONNECT:
            //g_pConnectView-&gt;PostMessage(WM_REMOVEFROMLIST, 0, (LPARAM)pContext);
            break;
        case NC_TRANSMIT:
            break;
        case NC_RECEIVE:
            //ProcessReceive(pContext);        //这里是有数据到来 但没有完全接收
            break;
        case NC_RECEIVE_COMPLETE:
            //ProcessReceiveComplete(pContext);       //这里时完全接收 处理发送来的数据 跟进    ProcessReceiveComplete
            break;
        &#125;
    &#125;
    catch (...) &#123;&#125;
&#125;</code></pre>
<p>添加定义：</p>
<pre><code>CIOCPServer* m_iocpServer = NULL;</code></pre>
<p><img src="https://s2.loli.net/2022/04/20/hoZIsSJyt1gfvaV.png"></p>
<p>4.复制Activate  代码 并处理</p>
<pre><code>void CMFCghostDlg::Activate(UINT nPort, UINT nMaxConnections)
&#123;
    CString        str;
    if (m_iocpServer != NULL)
    &#123;
        m_iocpServer-&gt;Shutdown();
        delete m_iocpServer;

    &#125;
    m_iocpServer = new CIOCPServer;

    ////lang2.1_8
    // 开启IPCP服务器 最大连接  端口     查看NotifyProc回调函数  函数定义
    if (m_iocpServer-&gt;Initialize(NotifyProc, NULL, 100000, nPort))
    &#123;

        char hostname[256];
        gethostname(hostname, sizeof(hostname));
        HOSTENT* host = gethostbyname(hostname);
        if (host != NULL)
        &#123;
            for (int i = 0; ; i++)
            &#123;
                str += inet_ntoa(*(IN_ADDR*)host-&gt;h_addr_list[i]);
                if (host-&gt;h_addr_list[i] + host-&gt;h_length &gt;= host-&gt;h_name)
                    break;
                str += &quot;/&quot;;
            &#125;
        &#125;

        //m_wndStatusBar.SetPaneText(0, str);
        //str.Format(&quot;端口: %d&quot;, nPort);
        //m_wndStatusBar.SetPaneText(2, str);
        str.Format(&quot;监听端口: %d成功&quot;, nPort);
        ShowMessage(true, str);
    &#125;
    else
    &#123;
        //str.Format(&quot;端口%d绑定失败&quot;, nPort);
        //m_wndStatusBar.SetPaneText(0, str);
        //m_wndStatusBar.SetPaneText(2, &quot;端口: 0&quot;);
        str.Format(&quot;监听端口: %d失败&quot;, nPort);
        ShowMessage(false, str);
    &#125;

    //m_wndStatusBar.SetPaneText(3, &quot;连接: 0&quot;);
&#125;
// CPCRemoteDlg 消息处理程序</code></pre>
<p>5.监听后添加日志消息</p>
<pre><code>str.Format(&quot;监听端口: %d成功&quot;, nPort);
ShowMessage(true,str);


//else
str.Format(&quot;监听端口: %d失败&quot;, nPort);
ShowMessage(false,str);</code></pre>
<p><img src="https://s2.loli.net/2022/04/20/24DxP6EzIUTSl3W.png"></p>
<p>6.测试  netstat -an</p>
<p>可以看到2000端口被占用</p>
<h1 id="ps-bmp文件格式"><a href="#ps-bmp文件格式" class="headerlink" title="ps bmp文件格式"></a>ps bmp文件格式</h1><p>1.一个bmp文件由四部分组成:</p>
<pre><code>     struCt tagBITMAPFIlEHEADER

     strut tagBITMAPINFOHEADER

     typedef tagRGBQUAD

     位图数据</code></pre>
<hr>
<h2 id="bmp文件结构解析"><a href="#bmp文件结构解析" class="headerlink" title="bmp文件结构解析"></a>bmp文件结构解析</h2><p>1.<br>typedef struCt tagBITMAPFIlEHEADER</p>
<p>{</p>
<p>WORD bftype；     //BM</p>
<p>DWORD bfsiZe：    //位图文件大小</p>
<p>WORD bfReservedl；  //必须为0</p>
<p>WORD bgReserved2：   //必修为0</p>
<p>DWORD bfoffBits： 图像数据在  文件内的起始地址</p>
<p>}BITMAPFILEHEADER；</p>
<p>2.<br>BITMAPINFOHEADER数据结构用于说明位图的大小，其定义为：</p>
<p>type struct tagBITMAPINFOHEADER</p>
<p>{ </p>
<p>DWORD biSize：   //结构BITMAPINFOHEADER所占用的存储容量，固定值为40</p>
<p>DWORD biWldth；  //给出该BMP文件所描述位图的宽度与高度</p>
<p>DWORD biHeight； //给出该BMP文件所描述位图的宽度与高度</p>
<p>WORD biPlanes： //它代表目标设备的平面数必须为1。</p>
<p>WORD biBitCount：  //它确定每个像素所需要的位数。 当图像为单色时，该字段的取值为1；当图像为16色时，该字段的取值为4；当图像为256 色时，该字段的取值为8；当图像为真彩色时，该字段的取值为24。</p>
<p>DWORD biCOmpression；//它代表bottom—up类型位图的 压缩类型</p>
<p>DWORD biSiZelmage； //给出该BMP 内图像数据占用的空间大小</p>
<p>DWORD biXPelsPerMeter：//它们分别以每米像素数为单位，给出位图目的设备水平以及垂直方向的 分辨率</p>
<p>DWORD biYPelsPerMeter：//它们分别以每米像素数为单位，给出位图目的设备水平以及垂直方向的 分辨率</p>
<p>DWORD biClrUsed；       //给出位图实际使用的颜色表中的 颜色变址数</p>
<p>DWORD biClrlmportant；//它给出位图显示过程中 重要颜色的变址数。</p>
<p>}BITMAPINFOHEADER；</p>
<p>3.调色板数据 </p>
<p>typedef struct tagRGBQUAD</p>
<p>{</p>
<p>BYTE rgbBlue；</p>
<p>BYTE rgbGreen；</p>
<p>BYTE rgbRed； </p>
<p>BYTE rgbReserved；       //它不代表任何意 义，必须取固定值00</p>
<p>}RGBQUAD；</p>
<p>3..  bmp结构还提供了另外一个结构类型   ，看他的成员定义就知道了<br>tyPedef stmCt tagBITMAPINFO </p>
<p>{</p>
<p>BITMAPINFOHEADER bmiHeader：   </p>
<p>RGBQUAD bmiC010ur[1]；</p>
<p>}BITMAPINFO；</p>
<p>4.位图数据<br>   注意位图数据的存放是倒序的 文件的第一行正是图像的最后一行</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">ME_dition</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2022/04/07/%E8%BF%9C%E6%8E%A7ghost/">http://example.com/2022/04/07/%E8%BF%9C%E6%8E%A7ghost/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2022/04/09/5ifjTZXhEPV4bLp.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/08/10/22.8.10xctf-pwn&amp;re/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info"></div></div></a></div><div class="next-post pull-right"><a href="/2022/03/21/BUUCTF%E7%AC%AC%E4%BA%8C%E9%A1%B5/"><img class="next-cover" src="https://i.loli.net/2021/01/30/IyhEQRXAS83oUtH.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">buuctf&amp;&amp;攻防世界</div></div></a></div></nav></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/null" onerror="this.onerror=null;this.src='/img/logo.jpg'" alt="avatar"/><div class="author-info__name">ME_dition</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">26</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">welcome to my world</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%95%8C%E9%9D%A2%E7%9A%84%E8%AE%BE%E8%AE%A1%E5%92%8C%E7%BC%96%E5%86%99"><span class="toc-number">1.</span> <span class="toc-text">客户端界面的设计和编写</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%88%9B%E5%BB%BA%E7%AA%97%E5%8F%A3"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 创建窗口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E6%B7%BB%E5%8A%A0%E5%88%97%E8%A1%A8%E4%B8%AD%E7%9A%84%E5%88%97%E5%90%8D"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 添加列表中的列名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E5%88%97%E8%A1%A8%E7%9A%84%E5%88%97%E5%AE%BD%E5%BA%A6%E6%94%AF%E6%8C%81%E4%BC%B8%E7%BC%A9"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 列表的列宽度支持伸缩</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E5%88%97%E8%A1%A8%E4%B8%AD%E6%B7%BB%E5%8A%A0%E6%9D%A1%E7%9B%AE"><span class="toc-number">1.4.</span> <span class="toc-text">1.4 列表中添加条目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-%E5%88%97%E8%A1%A8%E4%B8%AD%E6%98%BE%E7%A4%BA%E5%BC%B9%E5%87%BA%E8%8F%9C%E5%8D%95"><span class="toc-number">1.5.</span> <span class="toc-text">1.5 列表中显示弹出菜单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-6-%E6%B7%BB%E5%8A%A0%E8%8F%9C%E5%8D%95%E6%B6%88%E6%81%AF%E5%93%8D%E5%BA%94%EF%BC%8C%E4%BB%8E%E5%88%97%E8%A1%A8%E4%B8%AD%E5%88%A0%E9%99%A4%E6%9D%A1%E7%9B%AE"><span class="toc-number">1.6.</span> <span class="toc-text">1.6 添加菜单消息响应，从列表中删除条目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-7-%E4%B8%BA%E5%AF%B9%E8%AF%9D%E6%A1%86%E6%B7%BB%E5%8A%A0%E8%8F%9C%E5%8D%95%E6%A0%8F%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94"><span class="toc-number">1.7.</span> <span class="toc-text">1.7 为对话框添加菜单栏并添加事件响应</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-8-%E4%B8%BA%E5%AF%B9%E8%AF%9D%E6%A1%86%E6%B7%BB%E5%8A%A0%E7%8A%B6%E6%80%81%E6%9D%A1%E5%B9%B6%E5%9C%A8%E6%80%81%E6%9D%A1%E4%B8%8A%E6%98%BE%E7%A4%BA%E6%96%87%E5%AD%97"><span class="toc-number">1.8.</span> <span class="toc-text">1.8 为对话框添加状态条并在态条上显示文字</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-9-%E4%B8%BA%E5%AF%B9%E8%AF%9D%E6%A1%86%E6%B7%BB%E5%8A%A0%E5%85%A5%E5%B7%A5%E5%85%B7%E6%9D%A1"><span class="toc-number">1.9.</span> <span class="toc-text">1.9 为对话框添加入工具条</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-10-%E4%B8%BA%E7%A8%8B%E5%BA%8F%E6%B7%BB%E5%8A%A0%E7%B3%BB%E7%BB%9F%E6%89%98%E7%9B%98"><span class="toc-number">1.10.</span> <span class="toc-text">1.10 为程序添加系统托盘</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%8A%A0%E5%85%A5Socket%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E7%9A%84%E5%86%85%E6%A0%B8"><span class="toc-number">2.</span> <span class="toc-text">二、加入Socket数据传输的内核</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3"><span class="toc-number">2.1.</span> <span class="toc-text">2.3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4%E5%8A%A0%E5%85%A5%E7%AB%AF%E5%8F%A3%E7%9B%91%E5%90%AC%E5%8A%9F%E8%83%BD"><span class="toc-number">2.2.</span> <span class="toc-text">2.4加入端口监听功能</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ps-bmp%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">ps bmp文件格式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#bmp%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90"><span class="toc-number">3.1.</span> <span class="toc-text">bmp文件结构解析</span></a></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/08/10/22.8.10xctf-pwn&amp;re/" title="No title"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="No title"/></a><div class="content"><a class="title" href="/2022/08/10/22.8.10xctf-pwn&amp;re/" title="No title">No title</a><time datetime="2022-08-10T03:21:19.705Z" title="Created 2022-08-10 11:21:19">2022-08-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/07/%E8%BF%9C%E6%8E%A7ghost/" title="记第一个GitHub项目 --ghost远控"><img src="https://s2.loli.net/2022/04/09/5ifjTZXhEPV4bLp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="记第一个GitHub项目 --ghost远控"/></a><div class="content"><a class="title" href="/2022/04/07/%E8%BF%9C%E6%8E%A7ghost/" title="记第一个GitHub项目 --ghost远控">记第一个GitHub项目 --ghost远控</a><time datetime="2022-04-07T14:32:37.280Z" title="Created 2022-04-07 22:32:37">2022-04-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/21/BUUCTF%E7%AC%AC%E4%BA%8C%E9%A1%B5/" title="buuctf&amp;&amp;攻防世界"><img src="https://i.loli.net/2021/01/30/IyhEQRXAS83oUtH.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="buuctf&amp;&amp;攻防世界"/></a><div class="content"><a class="title" href="/2022/03/21/BUUCTF%E7%AC%AC%E4%BA%8C%E9%A1%B5/" title="buuctf&amp;&amp;攻防世界">buuctf&amp;&amp;攻防世界</a><time datetime="2022-03-21T15:10:57.539Z" title="Created 2022-03-21 23:10:57">2022-03-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/16/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/" title="Web学习 文件包含漏洞"><img src="https://s2.loli.net/2022/04/09/iW8lPrLuBGC1pKf.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Web学习 文件包含漏洞"/></a><div class="content"><a class="title" href="/2022/03/16/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/" title="Web学习 文件包含漏洞">Web学习 文件包含漏洞</a><time datetime="2022-03-16T15:39:11.539Z" title="Created 2022-03-16 23:39:11">2022-03-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/16/tcathe_%E4%BF%AE%E6%94%B9fd/" title="tcache结构体"><img src="https://i.loli.net/2021/11/16/VmMlbYZgdGvQkCw.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="tcache结构体"/></a><div class="content"><a class="title" href="/2022/03/16/tcathe_%E4%BF%AE%E6%94%B9fd/" title="tcache结构体">tcache结构体</a><time datetime="2022-03-16T10:19:57.832Z" title="Created 2022-03-16 18:19:57">2022-03-16</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://s2.loli.net/2022/04/09/5ifjTZXhEPV4bLp.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By ME_dition</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>